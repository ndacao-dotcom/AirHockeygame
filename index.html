<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Air Hockey</title>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#000;
  font-family:sans-serif;
  touch-action:none;
}
canvas{touch-action:none}

#score,#stageLabel{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  color:#fff;
  z-index:10;
}
#score{top:10px;font-size:20px}
#stageLabel{top:40px;font-size:16px;color:#ccc}

#menu,#settings,#message{
  position:absolute;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  background:rgba(0,0,0,.75);
  color:#fff;
  z-index:20;
}
button{padding:12px 24px;font-size:16px;margin:8px}
select{font-size:16px;margin:4px}
</style>
</head>

<body>

<div id="score">0 : 0</div>
<div id="stageLabel">STAGE 1</div>

<div id="menu">
  <h1>3Dエアホッケー</h1>
  <button onclick="startAdventure()">アドベンチャーモード</button>
  <button onclick="alert('未実装')">ともだちと対戦</button>
  <button onclick="openSettings()">環境設定</button>
</div>

<div id="settings">
  <h2>環境設定</h2>

  マレット色<br>
  <select id="malletColor">
    <option value="red">赤</option>
    <option value="blue">青</option>
    <option value="green">緑</option>
    <option value="yellow">黄色</option>
  </select><br>

  パック色<br>
  <select id="puckColor">
    <option value="white">白</option>
    <option value="black">黒</option>
  </select><br>

  フィールド色<br>
  <select id="fieldColor">
    <option value="white">白</option>
    <option value="black">黒</option>
    <option value="court">コート</option>
  </select><br>

  <button onclick="applySettings()">決定</button>
  <button onclick="showMenu()">戻る</button>
</div>

<div id="message"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
/* ===== 基本 ===== */
let scene,camera,renderer;
let field,puck,player,cpu;
let puckVel=new THREE.Vector3();

let stage=1,MAX_STAGE=9;
let playerScore=0,cpuScore=0;
let gameActive=false;

/* ===== UI ===== */
const scoreEl=document.getElementById('score');
const stageEl=document.getElementById('stageLabel');
const menu=document.getElementById('menu');
const settings=document.getElementById('settings');
const message=document.getElementById('message');

/* ===== 操作 ===== */
const raycaster=new THREE.Raycaster();
const pointer=new THREE.Vector2();
const playPlane=new THREE.Plane(new THREE.Vector3(0,1,0),0);

/* ===== サウンド ===== */
const hitSound=new Audio('hit.mp3');
const goalSound=new Audio('goal.mp3');
hitSound.volume=0.6;
goalSound.volume=0.7;

/* ===== 初期化 ===== */
init();
showMenu();
animate();

function init(){
  scene=new THREE.Scene();

  camera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,0.1,100);
  camera.position.set(0,7,7);
  camera.lookAt(0,0,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff,0.4));
  const light=new THREE.DirectionalLight(0xffffff,0.8);
  light.position.set(0,10,5);
  scene.add(light);

  field=new THREE.Mesh(
    new THREE.BoxGeometry(6,0.2,10),
    new THREE.MeshStandardMaterial({color:0x004488})
  );
  field.position.y=-0.1;
  scene.add(field);

  puck=new THREE.Mesh(
    new THREE.CylinderGeometry(0.25,0.25,0.1,32),
    new THREE.MeshStandardMaterial({color:0xffffff})
  );
  scene.add(puck);

  player=new THREE.Mesh(
    new THREE.CylinderGeometry(0.4,0.4,0.2,32),
    new THREE.MeshStandardMaterial({color:0xff0000})
  );
  scene.add(player);

  cpu=new THREE.Mesh(
    new THREE.CylinderGeometry(0.4,0.4,0.2,32),
    new THREE.MeshStandardMaterial({color:0x00ff00})
  );
  scene.add(cpu);

  /* 入力 */
  renderer.domElement.addEventListener('mousemove',e=>{
    if(gameActive) movePlayerByScreen(e.clientX,e.clientY);
  });

  renderer.domElement.addEventListener('touchstart',e=>{
    if(!gameActive) return;
    const t=e.touches[0];
    movePlayerByScreen(t.clientX,t.clientY);
    e.preventDefault();
  },{passive:false});

  renderer.domElement.addEventListener('touchmove',e=>{
    if(!gameActive) return;
    const t=e.touches[0];
    movePlayerByScreen(t.clientX,t.clientY);
    e.preventDefault();
  },{passive:false});

  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });
}

/* ===== 操作処理 ===== */
function movePlayerByScreen(x,y){
  pointer.x=(x/innerWidth)*2-1;
  pointer.y=-(y/innerHeight)*2+1;
  raycaster.setFromCamera(pointer,camera);

  const hit=new THREE.Vector3();
  if(raycaster.ray.intersectPlane(playPlane,hit)){
    player.position.x=THREE.MathUtils.clamp(hit.x,-2.7,2.7);
    player.position.z=THREE.MathUtils.clamp(hit.z,0.3,4.3);
  }
}

/* ===== ゲーム進行 ===== */
function startAdventure(){
  stage=1;
  startStage();
}

function startStage(){
  hideAll();
  playerScore=cpuScore=0;
  updateUI();
  player.position.set(0,0,4);
  cpu.position.set(0,0,-4);
  resetPuck();

  if(stage===8){
    showMessage('ラスボス出現！<br>パック・食ったる蔵','覚悟する',()=>{gameActive=true;});
    return;
  }
  if(stage===9){
    showMessage('裏ボス出現…<br>やまだたろう','無理ゲー開始',()=>{gameActive=true;});
    return;
  }
  gameActive=true;
}

function resetPuck(){
  puck.position.set(0,0,0);
  puckVel.set(0,0,0);
}

function getPuckSpeed(){
  if(stage===9) return 0.45;
  return 0.08 + stage*0.01;
}

function updatePhysics(){
  puck.position.add(puckVel);

  if(Math.abs(puck.position.x)>2.7) puckVel.x*=-1;

  if(puck.position.z>5){cpuScore++;afterGoal();}
  if(puck.position.z<-5){playerScore++;afterGoal();}

  /* CPU個性 */
  let cpuSpeed,targetX=puck.position.x;
  if(stage<=7){
    cpuSpeed=0.015+stage*0.003;
  }else if(stage===8){
    cpuSpeed=0.035;
    targetX+=puckVel.x*10;
  }else{
    cpuSpeed=0.08;
    targetX+=puckVel.x*25;
  }

  cpu.position.x+=THREE.MathUtils.clamp(
    targetX-cpu.position.x,
    -cpuSpeed,cpuSpeed
  );

  hit(player);
  hit(cpu);
}

function hit(m){
  const d=puck.position.distanceTo(m.position);
  if(d<0.6){
    const dir=puck.position.clone().sub(m.position).normalize();
    const s=getPuckSpeed();
    puckVel.x=dir.x*s;
    puckVel.z=dir.z*s;

    hitSound.currentTime=0;
    hitSound.play();
    if(navigator.vibrate) navigator.vibrate(15);
  }
}

function afterGoal(){
  goalSound.currentTime=0;
  goalSound.play();

  updateUI();
  if(playerScore>=3) win();
  else if(cpuScore>=3) lose();
  else resetPuck();
}

function updateUI(){
  scoreEl.textContent=`${playerScore} : ${cpuScore}`;
  stageEl.textContent=`STAGE ${stage}`;
}

function win(){
  gameActive=false;
  stage++;
  if(stage>MAX_STAGE){
    showMessage(
      'Congratulations！<br>こんなホッケーゲームやるから目が悪くなるんじゃ！',
      'メインメニューへ戻る',
      ()=>{stage=1;showMenu();}
    );
  }else{
    showMessage('ステージクリア','次のステージ',startStage);
  }
}

function lose(){
  gameActive=false;
  showMessage('敗北…','メインメニューへ戻る',()=>{stage=1;showMenu();});
}

/* ===== UI ===== */
function showMenu(){hideAll();menu.style.display='flex';}
function openSettings(){hideAll();settings.style.display='flex';}

function applySettings(){
  player.material.color.set(document.getElementById('malletColor').value);
  puck.material.color.set(document.getElementById('puckColor').value);
  const f=document.getElementById('fieldColor').value;
  field.material.color.set(
    f==='white'?0xffffff:f==='black'?0x000000:0x004488
  );
  showMenu();
}

function hideAll(){
  menu.style.display=settings.style.display=message.style.display='none';
}

function showMessage(text,btn,cb){
  hideAll();
  message.innerHTML=`<h2>${text}</h2><button>${btn}</button>`;
  message.querySelector('button').onclick=cb;
  message.style.display='flex';
}

function animate(){
  requestAnimationFrame(animate);
  if(gameActive) updatePhysics();
  renderer.render(scene,camera);
}
</script>
</body>
</html>
